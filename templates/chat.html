<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>NEURAL BITES // AI CONCIERGE</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>

    <style>
        :root {
            --bg: #0a0a0a;
            --panel: rgba(255, 255, 255, 0.05);
            --neon: #00f3ff;
            --bot-msg: #ff0055;
            --text: #fff;
        }

        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; overflow: hidden; height: 100vh; display: flex; }

        .chat-section {
            width: 400px;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(20px);
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            z-index: 10;
            box-shadow: 10px 0 50px rgba(0,0,0,0.5);
        }

        /* FIX 1: Added color to border-bottom */
        .header { padding: 20px; border-bottom: 1px solid #333; }
        .logo { font-family: 'Orbitron', sans-serif; color: var(--neon); font-size: 1.5rem; letter-spacing: 2px; text-shadow: 0 0 10px var(--neon); }

        .chat-window {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 12px 18px;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.4;
            opacity: 0;
            transform: translateY(20px);
        }

        .msg-bot { align-self: flex-start; background: var(--panel); border-left: 3px solid var(--bot-msg); color: #ddd; }
        .msg-user { align-self: flex-end; background: rgba(0, 243, 255, 0.1); border-right: 3px solid var(--neon); color: var(--neon); text-align: right; }

        .input-area { padding: 20px; border-top: 1px solid #333; display: flex; gap: 10px; }

        input {
            flex: 1; background: #111; border: 1px solid #333; color: #fff; padding: 12px; border-radius: 6px; outline: none; transition: 0.3s;
        }
        input:focus { border-color: var(--neon); box-shadow: 0 0 15px rgba(0, 243, 255, 0.2); }

        button { background: var(--neon); border: none; padding: 0 20px; font-weight: bold; cursor: pointer; border-radius: 6px; }

        .visual-section { flex: 1; position: relative; }
        #map { width: 100%; height: 100%; z-index: 1; opacity: 0.6; }

        .cards-overlay {
            position: absolute; bottom: 30px; left: 30px; right: 30px;
            display: flex; gap: 20px; overflow-x: auto; z-index: 5;
            padding-bottom: 10px; pointer-events: none; /* Let clicks pass through to map */
        }
        
        .food-card {
            pointer-events: auto; /* Re-enable clicks on cards */
            min-width: 250px; background: rgba(10, 10, 10, 0.9);
            border: 1px solid var(--neon); padding: 15px;
            border-radius: 10px; box-shadow: 0 0 20px rgba(0, 243, 255, 0.1);
            transform: translateY(100px);
        }
        .food-title { font-family: 'Orbitron'; color: #fff; margin-bottom: 5px; font-size: 1.1rem; }
        .food-type { color: #888; font-size: 0.8rem; text-transform: uppercase; }
        .food-img { width: 100%; height: 120px; object-fit: cover; border-radius: 5px; margin-bottom: 10px; opacity: 0.8; }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            .chat-section { width: 100%; height: 40%; }
            .visual-section { height: 60%; }
        }
    </style>
</head>
<body>

    <div class="chat-section">
        <div class="header">
            <div class="logo">NEURAL BITES</div>
        </div>
        <div class="chat-window" id="chatbox">
            <div class="message msg-bot" id="intro-msg">
                SYSTEM ONLINE. <br>
                Tell me what you crave and which city you are in.<br>
                (e.g., "I want spicy food in New York")
            </div>
        </div>
        <div class="input-area">
            <input type="text" id="userInput" placeholder="Command..." autofocus onkeypress="handleEnter(event)">
            <button onclick="sendMessage()">SEND</button>
        </div>
    </div>

    <div class="visual-section">
        <div id="map"></div>
        <div class="cards-overlay" id="cardContainer"></div>
    </div>

    <script>
        gsap.to("#intro-msg", { opacity: 1, y: 0, duration: 0.8, ease: "power2.out" });

        const map = L.map('map').setView([20, 0], 2);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);

        let markers = [];

        function handleEnter(e) { if(e.key === 'Enter') sendMessage(); }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const txt = input.value;
            if(!txt) return;

            addMessage(txt, 'user');
            input.value = '';

            const loadId = addMessage("Analyzing neural pathways...", 'bot');

            try {
                const response = await fetch('/api/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: txt })
                });
                const data = await response.json();

                document.getElementById(loadId).innerHTML = data.reply;
                
                // FIX 5: Check if places exists to prevent crash
                if(data.location && data.places) {
                    updateMap(data.location, data.places);
                }

            } catch (err) {
                console.error(err);
                document.getElementById(loadId).innerHTML = "CONNECTION ERROR. RE-ALIGNING SATELLITE.";
            }
        }

        function addMessage(text, type) {
            const box = document.getElementById('chatbox');
            const div = document.createElement('div');
            const id = 'msg-' + Date.now();
            div.id = id;
            div.className = `message msg-${type}`;
            div.innerHTML = text;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            gsap.to(div, { opacity: 1, y: 0, duration: 0.5 });
            return id;
        }

        function updateMap(loc, places) {
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            const container = document.getElementById('cardContainer');
            container.innerHTML = '';

            if (places.length === 0) {
                return;
            }

            map.flyTo([loc.lat, loc.lon], 13, { duration: 2.5 });

            places.forEach((p, index) => {
                const m = L.circleMarker([p.lat, p.lon], {
                    color: '#00f3ff', radius: 8, fillOpacity: 0.8
                }).addTo(map).bindPopup(p.name);
                markers.push(m);

                const card = document.createElement('div');
                card.className = 'food-card';
                
                // FIX 2: Replaced broken Unsplash source with loremflickr
                card.innerHTML = `
                    <img class="food-img" src="https://loremflickr.com/400/300/${p.type},dinner/all" alt="food">
                    <div class="food-title">${p.name}</div>
                    <div class="food-type">Detected: ${p.type}</div>
                `;
                container.appendChild(card);

                gsap.to(card, { 
                    y: 0, 
                    duration: 0.8, 
                    delay: 0.5 + (index * 0.1), 
                    ease: "back.out(1.7)" 
                });
            });
        }
    </script>
</body>
</html>