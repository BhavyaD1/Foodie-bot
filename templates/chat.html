<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEURAL BITES // AI CONCIERGE</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>

    <style>
        :root {
            --bg: #0a0a0a;
            --panel: rgba(255, 255, 255, 0.05);
            --neon: #00f3ff;
            --bot-msg: #ff0055;
            --text: #fff;
        }

        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; overflow: hidden; height: 100vh; display: flex; }

        .chat-section {
            width: 400px;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(20px);
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            z-index: 10;
        }

        .header { padding: 20px; border-bottom: 1px solid #333; }
        .logo { font-family: 'Orbitron', sans-serif; color: var(--neon); font-size: 1.5rem; letter-spacing: 2px; text-shadow: 0 0 10px var(--neon); }

        .chat-window {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            scrollbar-width: thin;
            scrollbar-color: var(--neon) transparent;
        }

        .message {
            max-width: 85%;
            padding: 12px 18px;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.4;
            opacity: 0;
            transform: translateY(20px);
        }

        .msg-bot { align-self: flex-start; background: var(--panel); border-left: 3px solid var(--bot-msg); color: #ddd; }
        .msg-user { align-self: flex-end; background: rgba(0, 243, 255, 0.1); border-right: 3px solid var(--neon); color: var(--neon); text-align: right; }

        .restaurant-link {
            display: block;
            margin-top: 8px;
            color: var(--neon);
            text-decoration: none;
            font-weight: bold;
            border: 1px solid rgba(0, 243, 255, 0.3);
            padding: 5px 10px;
            border-radius: 4px;
            transition: 0.3s;
        }

        .restaurant-link:hover { background: var(--neon); color: #000; }

        .input-area { padding: 20px; border-top: 1px solid #333; display: flex; gap: 10px; }
        input { flex: 1; background: #111; border: 1px solid #333; color: #fff; padding: 12px; border-radius: 6px; outline: none; }
        input:focus { border-color: var(--neon); }
        button { background: var(--neon); border: none; padding: 0 20px; font-weight: bold; cursor: pointer; border-radius: 6px; }

        .visual-section { flex: 1; position: relative; }
        #map { width: 100%; height: 100%; z-index: 1; }

        /* Custom Popup Style */
        .leaflet-popup-content-wrapper { background: #111; color: white; border: 1px solid var(--neon); }
        .leaflet-popup-tip { background: var(--neon); }
    </style>
</head>
<body>

    <div class="chat-section">
        <div class="header"><div class="logo">NEURAL BITES</div></div>
        <div class="chat-window" id="chatbox">
            <div class="message msg-bot" id="intro-msg">
                SYSTEM ONLINE. <br>
                Tell me what you crave and which city you are in.
            </div>
        </div>
        <div class="input-area">
            <input type="text" id="userInput" placeholder="Command..." autofocus onkeypress="handleEnter(event)">
            <button onclick="sendMessage()">SEND</button>
        </div>
    </div>

    <div class="visual-section">
        <div id="map"></div>
    </div>

    <script>
        gsap.to("#intro-msg", { opacity: 1, y: 0, duration: 0.8 });

        const map = L.map('map').setView([20, 0], 2);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        let markers = [];

        function handleEnter(e) { if(e.key === 'Enter') sendMessage(); }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const txt = input.value;
            if(!txt) return;

            addMessage(txt, 'user');
            input.value = '';
            const loadId = addMessage("Scanning sectors...", 'bot');

            try {
                const response = await fetch('/api/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: txt })
                });
                const data = await response.json();

                document.getElementById(loadId).innerHTML = data.reply;
                
                if(data.location && data.places) {
                    updateMap(data.location, data.places);
                }
            } catch (err) {
                document.getElementById(loadId).innerHTML = "CRITICAL ERROR: UPLINK FAILED.";
            }
        }

        function addMessage(text, type) {
            const box = document.getElementById('chatbox');
            const div = document.createElement('div');
            const id = 'msg-' + Date.now();
            div.id = id;
            div.className = `message msg-${type}`;
            div.innerHTML = text;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            gsap.to(div, { opacity: 1, y: 0, duration: 0.4 });
            return id;
        }

        function updateMap(loc, places) {
            // Remove old markers
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            
            // Zoom to location
            map.flyTo([loc.lat, loc.lon], 14, { duration: 2 });

            if (places.length > 0) {
                const box = document.getElementById('chatbox');
                const listDiv = document.createElement('div');
                listDiv.className = "message msg-bot";
                let html = "<strong>LOCATIONS FOUND:</strong><br>";

                places.forEach(p => {
                    // Create Map Marker
                    const m = L.circleMarker([p.lat, p.lon], {
                        color: '#00f3ff', fillColor: '#00f3ff', fillOpacity: 0.8, radius: 10
                    }).addTo(map);
                    
                    // Add Popup with Google Maps link to Pin
                    m.bindPopup(`
                        <div style="color:white;">
                            <strong>${p.name}</strong><br>
                            <a href="${p.link}" target="_blank" style="color:#00f3ff; text-decoration:none;">View on Google Maps ↗</a>
                        </div>
                    `);
                    markers.push(m);

                    // Build list for Chatbox
                    html += `<a href="${p.link}" target="_blank" class="restaurant-link">${p.name} ↗</a>`;
                });

                listDiv.innerHTML = html;
                box.appendChild(listDiv);
                box.scrollTop = box.scrollHeight;
                gsap.to(listDiv, { opacity: 1, y: 0, duration: 0.4 });
            }
        }
    </script>
</body>
</html>